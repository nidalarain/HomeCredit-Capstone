---
title: "Able.com Case"
author: "Nidal Arain"
date: "2024-08-24"
output: 
  html_document: 
    toc: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Loading Data

```{r}
# Loading libraries
library(tidyverse)
library(dplyr)
library(ggplot2)

nidalio <- c(1,2,3)
rayansafatty <- c(1,2,3,4,5,6)

#aadding more coments to commit change

# Loading the data
toy_sales <- read.csv("https://raw.githubusercontent.com/jefftwebb/data/main/toy_sales_data.csv")
head(toy_sales)

# Loading the potential outcomes data
toy_sales_PO <- read.csv("https://raw.githubusercontent.com/jefftwebb/data/main/toy_sales_PO.csv")
head(toy_sales_PO)
```

## Question 1
What is the true ATE of having a sale?

The true ate of having a sale is 45.90

```{r pressure, echo=FALSE}
#Calculating true ATE using the potential outcomes data
trueate <- mean(toy_sales_PO$y1) - mean(toy_sales_PO$y0)
trueate

```



## Question 2
What is the estimated ATE of having a sale using the observed data, toy_sales.csv? 

The estimated ATE of having a sale using the observed data is 77.94

```{r}
#estimating ATE 
estimated_ate <- toy_sales %>% group_by(is_on_sale) %>%
  summarize(salez_mean = mean(weekly_amount_sold))

#finding difference between sales during a sale (is_on_sale == 1) and not a sale (is_on_sale == 0)
estimated_atevalue <- estimated_ate$salez_mean[2] - estimated_ate$salez_mean[1]
estimated_atevalue
```


## Question 3
What is the bias involved in using the observed data to estimate ATE?

The bias involved in using the observed data to estimate ATE is 32.04
```{r}
#calculating the bias (ATE - ^ATE)
bias <- estimated_atevalue - trueate
bias

```

## Question 4
A balance table is used to check whether the treatment and control groups in a study are exchangeable based on pre-treatment characteristics. Create a balance table using the observed data (toy_sales.csv) that shows how company size varies by treatment status. Comment on the exchangeability of the groups.

As far as exchangeability, the difference in mean sizes shows that the treatment (is_on_sale = 1) and control (is_on_sale = 0) groups may not be completely exchangeable. The higher standard deviation in the treatment group also shows that thereâ€™s more variability in the characteristics of businesses that choose to run sales, which could complicate exchangability.

```{r}
#creating a balance table for company size by treatment status
balance <- toy_sales %>% group_by(is_on_sale) %>%
summarize(count = n(), mean_size = mean(avg_week_sales), sd_size = sd(avg_week_sales))

balance
```

## Question 5
Company size confounds the relationship between weekly_amount_sold and is_on_sale in the observed data (toy_sales.csv). Create a statistical model to adjust for the confounding. Hint: use linear regression.

Report an adjusted ATE. How does it compare to the true ATE?
The adjusted ATE from the model is higher than the true ATE which suggests the adjustment helps to reduce some bias.

Explain how the adjustment is working.
The adjustment in the linear regression model works by including avg_week_sales as a covariate, which then also takes into acount the influence of company size on both the likelihood of running a sale and the number of units sold. 


```{r}
#linear regression model that adjusts for confounding
model <- lm(weekly_amount_sold ~ is_on_sale + avg_week_sales, data = toy_sales)
summary(model)

#taking out the coefficient for is_on_sale to get the adjusted ATE
adjusted_ate <- coef(model)["is_on_sale"]
adjusted_ate

```


## Question 6
The conditional average treatment effect or CATE is defined as the average treatment effect for a subgroup of the data. Think of weeks_to_xmas as defining subgroups with levels equal to 3, 2, 1, 0. What is the true ATE of a sales campaign conditional on weeks to Christmas?

Use toy_sales_PO.csv for the calculation.
You should report 4 numbers and make a comment.

True CATE by weeks to Christmas
0 weeks to Christmas: 38.75
1 week to Christmas: 46.14
2 weeks to Christmas: 48.94
3 weeks to Christmas: 49.78

The CATE increases as you move from 0 to 3 weeks before Christmas which shows that the impact of running a sale tends to be stronger the further away it is from Christmas.


```{r}
#calculating CATE by weeks to Christmas
cate<- toy_sales_PO %>% group_by(weeks_to_xmas) %>%
  summarize(true_cate = mean(y1 - y0))

cate

```


## Question 7

Use a statistical model to estimate the adjusted ATE of a sales campaign conditional on weeks to Christmas. Hint: add an interaction term to your earlier regression model.

Use toy_sales.csv for the estimate.
Again, you should report 4 numbers and make a comment addressing whether estimated CATE is higher or lower than the true CATE you calculated for the previous question. Simply outputting your regression results will not suffice!
Challenge: create a plot that illustrates the statistical result.

Adjusted CATE
0 weeks to Christmas: 37.80
1 week to Christmas: 47.29
2 weeks to Christmas: 56.78
3 weeks to Christmas: 66.27

The adjusted CATEs are generally higher than the true CATEs, especially as you move further away from Christmas. The overestimation could be due to the way the interaction between is_on_sale and weeks_to_xmas is modeled.

```{r}
#linear model with interaction between is_on_sale and weeks_to_xmas
catemodel <- lm(weekly_amount_sold ~ is_on_sale * weeks_to_xmas + avg_week_sales, data = toy_sales)
#model summary
summary(catemodel)

#taking out coefficients for the interaction term
coefficients <- coef(catemodel)

#adjusted CATE for each week
adj_cate <- coefficients['is_on_sale'] + coefficients['is_on_sale:weeks_to_xmas'] * c(0, 1, 2, 3)
adj_cate



#attempting challenge to plot statistical result

#data frame with the results
results <- data.frame(
  weeks_to_xmas = c(0, 1, 2, 3),
  adjusted_cate = c(37.80, 47.29, 56.78, 66.27),  #adjusted CATEs from the model
  true_cate = c(38.75, 46.14, 48.94, 49.78)  #true CATEs 
)


# making a line the plot
ggplot(results, aes(x = weeks_to_xmas)) +
  #plotting adjusted cates
  geom_line(aes(y = adjusted_cate)) + geom_point(aes(y = adjusted_cate)) +
  
  #plotting true cates
geom_line(aes(y = true_cate)) +geom_point(aes(y = true_cate)) +
  labs(title = "Comparison of Adjusted vs True CATE by Weeks to Christmas",
       x = "Weeks to Christmas",
       y = "CATE")  
  

```


